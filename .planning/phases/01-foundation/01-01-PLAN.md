---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - next.config.ts
  - tsconfig.json
  - .env.local
  - .env.example
  - .gitignore
  - src/db/index.ts
  - src/db/schema.ts
  - src/lib/supabase/client.ts
  - src/lib/supabase/server.ts
  - drizzle.config.ts
autonomous: true

must_haves:
  truths:
    - "Next.js 15 dev server starts without errors"
    - "Supabase client connects to project"
    - "Drizzle can query database"
    - "TypeScript compiles without errors"
  artifacts:
    - path: "package.json"
      provides: "Project dependencies"
      contains: "@supabase/ssr"
    - path: "src/db/index.ts"
      provides: "Drizzle database client"
      exports: ["db"]
    - path: "src/lib/supabase/client.ts"
      provides: "Browser Supabase client"
      exports: ["createClient"]
    - path: "src/lib/supabase/server.ts"
      provides: "Server Supabase client"
      exports: ["createClient"]
  key_links:
    - from: "src/db/index.ts"
      to: "DATABASE_URL"
      via: "postgres connection string"
      pattern: "process\\.env\\.DATABASE_URL"
    - from: "src/lib/supabase/server.ts"
      to: "NEXT_PUBLIC_SUPABASE_URL"
      via: "environment variable"
      pattern: "process\\.env\\.NEXT_PUBLIC_SUPABASE"
---

<objective>
Initialize Next.js 15 project with Supabase integration and Drizzle ORM for the JL Taxes platform.

Purpose: Establish the technical foundation for authentication, database access, and server-side rendering that all subsequent features will build upon.

Output: Working Next.js 15 project with configured Supabase clients (browser + server), Drizzle ORM connection, and environment setup.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Next.js 15 with TypeScript and install dependencies</name>
  <files>
    - package.json
    - next.config.ts
    - tsconfig.json
    - .gitignore
  </files>
  <action>
Create Next.js 15 project in the repository root using:
```bash
npx create-next-app@latest . --typescript --tailwind --eslint --app --src-dir --import-alias "@/*" --turbopack
```

If prompted about existing files, allow overwrite (the repo currently only has .planning and .claude directories).

After creation, install required dependencies:
```bash
npm install @supabase/ssr @supabase/supabase-js drizzle-orm postgres react-hook-form zod @hookform/resolvers
npm install -D drizzle-kit @types/pg
```

Update `next.config.ts` to handle Supabase edge runtime compatibility:
```typescript
import type { NextConfig } from 'next';

const nextConfig: NextConfig = {
  experimental: {
    serverActions: {
      bodySizeLimit: '2mb',
    },
  },
};

export default nextConfig;
```

Ensure `.gitignore` includes:
- .env.local
- .env*.local
- node_modules
  </action>
  <verify>
Run `npm run dev` - server should start on localhost:3000 without errors.
Run `npm run build` - should compile without TypeScript errors.
  </verify>
  <done>
Next.js 15 dev server starts successfully. All dependencies installed. TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure Supabase clients and environment</name>
  <files>
    - .env.local
    - .env.example
    - src/lib/supabase/client.ts
    - src/lib/supabase/server.ts
  </files>
  <action>
Create `.env.example` with placeholder values (for git):
```
# Supabase
NEXT_PUBLIC_SUPABASE_URL=your-project-url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key

# Database (Supabase connection pooler - Transaction mode)
DATABASE_URL=postgresql://postgres.[project-ref]:[password]@aws-0-[region].pooler.supabase.com:6543/postgres

# App
NEXT_PUBLIC_SITE_URL=http://localhost:3000
```

Create `.env.local` with actual Supabase credentials. The user must have a Supabase project created. Use the Supabase Dashboard values:
- Project Settings > API > Project URL
- Project Settings > API > anon public key
- Project Settings > Database > Connection string (Transaction pooler)

Create `src/lib/supabase/client.ts`:
```typescript
import { createBrowserClient } from '@supabase/ssr';

export function createClient() {
  return createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  );
}
```

Create `src/lib/supabase/server.ts`:
```typescript
import { createServerClient } from '@supabase/ssr';
import { cookies } from 'next/headers';

export async function createClient() {
  const cookieStore = await cookies();

  return createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return cookieStore.getAll();
        },
        setAll(cookiesToSet) {
          try {
            cookiesToSet.forEach(({ name, value, options }) =>
              cookieStore.set(name, value, options)
            );
          } catch {
            // Called from Server Component - ignore
          }
        },
      },
    }
  );
}
```

IMPORTANT: Use `@supabase/ssr` package (NOT deprecated `@supabase/auth-helpers-nextjs`).
  </action>
  <verify>
Check files exist: `ls src/lib/supabase/`
Import test: Create a temporary test in a server component that calls `createClient()` and logs the URL - should not throw.
  </verify>
  <done>
Supabase browser and server clients created. Environment variables configured. `.env.example` committed for reference.
  </done>
</task>

<task type="auto">
  <name>Task 3: Set up Drizzle ORM with database schema</name>
  <files>
    - src/db/index.ts
    - src/db/schema.ts
    - drizzle.config.ts
  </files>
  <action>
Create `drizzle.config.ts` in project root:
```typescript
import { defineConfig } from 'drizzle-kit';

export default defineConfig({
  schema: './src/db/schema.ts',
  out: './drizzle',
  dialect: 'postgresql',
  dbCredentials: {
    url: process.env.DATABASE_URL!,
  },
});
```

Create `src/db/index.ts`:
```typescript
import { drizzle } from 'drizzle-orm/postgres-js';
import postgres from 'postgres';
import * as schema from './schema';

// Use connection pooling with Transaction mode (disable prepare for Supabase pooler)
const client = postgres(process.env.DATABASE_URL!, {
  prepare: false,
});

export const db = drizzle(client, { schema });
```

Create `src/db/schema.ts` with initial user preferences table (extends Supabase auth.users):
```typescript
import { pgTable, uuid, text, timestamp, pgEnum } from 'drizzle-orm/pg-core';

// Language enum matching i18n config
export const languageEnum = pgEnum('language', ['es', 'en', 'de', 'fr']);

// User preferences (extends Supabase auth.users via foreign key)
export const userPreferences = pgTable('user_preferences', {
  id: uuid('id').primaryKey().defaultRandom(),
  userId: uuid('user_id').notNull().unique(), // References auth.users(id)
  preferredLanguage: languageEnum('preferred_language').default('es').notNull(),
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
});

// Type exports for TypeScript
export type UserPreference = typeof userPreferences.$inferSelect;
export type NewUserPreference = typeof userPreferences.$inferInsert;
```

Add script to package.json:
```json
{
  "scripts": {
    "db:push": "drizzle-kit push",
    "db:studio": "drizzle-kit studio"
  }
}
```

Run `npm run db:push` to sync schema to Supabase database.
  </action>
  <verify>
Run `npm run db:push` - should create tables without errors.
Run `npm run db:studio` - Drizzle Studio should open and show the user_preferences table.
  </verify>
  <done>
Drizzle ORM configured. Schema pushed to Supabase database. user_preferences table exists with language enum.
  </done>
</task>

</tasks>

<verification>
1. `npm run dev` starts without errors
2. `npm run build` completes successfully
3. Supabase client files exist in `src/lib/supabase/`
4. Drizzle schema pushed to database
5. All TypeScript types resolve correctly
</verification>

<success_criteria>
- Next.js 15 project initialized with App Router and src/ directory
- All dependencies installed (@supabase/ssr, drizzle-orm, react-hook-form, zod)
- Supabase browser and server clients created following official patterns
- Drizzle ORM connected to Supabase PostgreSQL
- Initial schema with user_preferences table deployed
- Environment variables documented in .env.example
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md` following the summary template.
</output>
