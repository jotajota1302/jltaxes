---
phase: 02-owner-property-data
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/db/schema.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Owners table exists with NIE/NIF, residence, and IBAN fields"
    - "Properties table exists with Spanish address structure and cadastral data"
    - "Junction table tracks ownership percentage per owner-property pair"
    - "Database migrations can be pushed without errors"
  artifacts:
    - path: "src/db/schema.ts"
      provides: "Database schema for owners, properties, ownerProperties tables"
      contains: "ownerTypeEnum, streetTypeEnum, owners, properties, ownerProperties"
    - path: "package.json"
      provides: "Zustand dependency for multi-step forms"
      contains: "zustand"
  key_links:
    - from: "src/db/schema.ts"
      to: "drizzle-orm/pg-core"
      via: "import"
      pattern: "pgTable.*uuid.*text.*timestamp"
    - from: "ownerProperties"
      to: "owners, properties"
      via: "foreign key references"
      pattern: "references.*owners.id.*properties.id"
---

<objective>
Create the database schema for owners, properties, and the many-to-many junction table with ownership percentages.

Purpose: Foundation for all owner and property data management - Phase 2 requires storing fiscal data for tax declarations
Output: Extended Drizzle schema with owners, properties, and ownerProperties tables ready for migrations
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-owner-property-data/02-RESEARCH.md

# Existing schema to extend
@src/db/schema.ts

# Research provides complete schema definition with:
# - ownerTypeEnum ('individual', 'company')
# - streetTypeEnum (Spanish street types)
# - owners table (taxId, residence, IBAN)
# - properties table (Spanish address, cadastral data)
# - ownerProperties junction table (ownership percentage)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Zustand for multi-step form state</name>
  <files>package.json</files>
  <action>
Install zustand for multi-step form state persistence (used in plans 03 and 04):

```bash
npm install zustand
```

Zustand will be used for wizard forms that need to persist state across steps and browser navigation. Installing now so schema types are available for store definitions.
  </action>
  <verify>
Run: `npm ls zustand` confirms package installed
Run: `npm run build` still succeeds (no import errors)
  </verify>
  <done>Zustand appears in package.json dependencies</done>
</task>

<task type="auto">
  <name>Task 2: Extend database schema with owners, properties, and junction table</name>
  <files>src/db/schema.ts</files>
  <action>
Extend the existing schema.ts file with the following (keep existing userPreferences table):

1. Add enums at the top:
   - ownerTypeEnum: 'individual' | 'company'
   - streetTypeEnum: 'calle' | 'avenida' | 'plaza' | 'paseo' | 'carretera' | 'camino' | 'travesia' | 'urbanizacion' | 'otro'

2. Add owners table:
   - id: UUID primary key
   - userId: UUID not null (references auth.users conceptually, not FK due to Supabase)
   - ownerType: ownerTypeEnum not null
   - taxId: varchar(20) not null (stores normalized NIE/NIF/CIF)
   - taxIdType: varchar(10) (stores 'NIE', 'NIF', 'CIF')
   - firstName, lastName: varchar(100) for individuals
   - companyName: varchar(200) for companies
   - residenceCountry: varchar(2) not null (ISO 3166-1 alpha-2)
   - residenceAddress: text not null
   - residenceCity: varchar(100) not null
   - residencePostalCode: varchar(10) not null
   - iban: varchar(34) (optional, for refunds)
   - createdAt, updatedAt: timestamps

3. Add properties table:
   - id: UUID primary key
   - userId: UUID not null
   - streetType: streetTypeEnum not null
   - streetName: varchar(200) not null
   - streetNumber: varchar(10) not null
   - floor, door, staircase, block: varchar(10) each (optional)
   - city: varchar(100) not null
   - province: varchar(100) not null
   - postalCode: varchar(5) not null (Spanish postal codes are 5 digits)
   - cadastralReference: varchar(20) not null
   - cadastralValue: decimal(12,2) not null
   - collectiveRevision: boolean default false (1.1% vs 2% rate)
   - revisionYear: integer (year of last cadastral revision)
   - createdAt, updatedAt: timestamps

4. Add ownerProperties junction table:
   - id: UUID primary key
   - ownerId: UUID not null, references owners.id with onDelete: 'cascade'
   - propertyId: UUID not null, references properties.id with onDelete: 'cascade'
   - ownershipPercentage: decimal(5,2) not null (0.00 to 100.00)
   - createdAt: timestamp

5. Add Drizzle relations for the many-to-many relationship:
   - ownersRelations: many ownerProperties
   - propertiesRelations: many ownerProperties
   - ownerPropertiesRelations: one owner, one property

6. Export types:
   - Owner, NewOwner (from owners table)
   - Property, NewProperty (from properties table)
   - OwnerProperty (from ownerProperties table)

Reference the exact structure from 02-RESEARCH.md Pattern 5.
  </action>
  <verify>
Run: `npx tsc --noEmit` - no TypeScript errors
Run: `npx drizzle-kit generate` - generates migration successfully (if drizzle.config.ts exists)
Confirm: All type exports compile correctly
  </verify>
  <done>
Schema file contains owners, properties, ownerProperties tables with all required fields.
TypeScript types exported for Owner, NewOwner, Property, NewProperty, OwnerProperty.
Relations defined for many-to-many querying.
  </done>
</task>

</tasks>

<verification>
1. Run `npm ls zustand` - package installed
2. Run `npx tsc --noEmit` - no TypeScript errors in schema
3. Schema exports: Owner, NewOwner, Property, NewProperty, OwnerProperty types
4. Schema contains ownerTypeEnum, streetTypeEnum enums
5. ownerProperties has foreign key references to owners and properties
</verification>

<success_criteria>
- Zustand installed in package.json
- src/db/schema.ts contains complete owner/property/junction schema
- All TypeScript types compile without errors
- Schema ready for Drizzle migration push
- Foreign key relationships defined with cascade delete
</success_criteria>

<output>
After completion, create `.planning/phases/02-owner-property-data/02-01-SUMMARY.md`
</output>
