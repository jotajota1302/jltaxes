---
phase: 01-foundation
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/i18n/routing.ts
  - src/i18n/navigation.ts
  - src/i18n/request.ts
  - src/middleware.ts
  - src/app/[locale]/layout.tsx
  - src/app/[locale]/page.tsx
  - src/messages/es.json
  - src/messages/en.json
  - src/messages/de.json
  - src/messages/fr.json
  - next.config.ts
autonomous: true

must_haves:
  truths:
    - "User can visit /es, /en, /de, /fr and see localized content"
    - "Default locale (es) works without prefix at root /"
    - "Translations load from JSON files and display correctly"
    - "useTranslations hook works in client and server components"
    - "Locale persists across navigation"
  artifacts:
    - path: "src/i18n/routing.ts"
      provides: "Locale routing configuration"
      exports: ["routing"]
    - path: "src/i18n/navigation.ts"
      provides: "Localized navigation APIs"
      exports: ["Link", "redirect", "usePathname", "useRouter"]
    - path: "src/middleware.ts"
      provides: "Combined i18n + auth middleware"
      contains: "createIntlMiddleware"
    - path: "src/messages/es.json"
      provides: "Spanish translations"
      contains: "common"
  key_links:
    - from: "src/middleware.ts"
      to: "src/i18n/routing.ts"
      via: "import routing config"
      pattern: "import.*routing"
    - from: "src/app/[locale]/layout.tsx"
      to: "next-intl"
      via: "NextIntlClientProvider"
      pattern: "NextIntlClientProvider"
---

<objective>
Set up next-intl for internationalization with 4 languages (ES, EN, DE, FR) and locale-based routing.

Purpose: Enable multilingual interface (I18N-01 to I18N-06) so users can access the platform in their preferred language. Spanish is the default locale.

Output: Working i18n infrastructure with locale routing ([locale] segment), translation files for all 4 languages, and combined middleware for locale detection.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure next-intl routing and navigation</name>
  <files>
    - src/i18n/routing.ts
    - src/i18n/navigation.ts
    - src/i18n/request.ts
    - next.config.ts
  </files>
  <action>
Install next-intl:
```bash
npm install next-intl
```

Create the i18n directory and configuration files:

**src/i18n/routing.ts** - Define supported locales:
```typescript
import { defineRouting } from 'next-intl/routing';

export const routing = defineRouting({
  // Supported locales (I18N-01 to I18N-04)
  locales: ['es', 'en', 'de', 'fr'],
  // Spanish as default (primary market is Spain-based properties)
  defaultLocale: 'es',
  // Locale prefix strategy
  localePrefix: 'as-needed'  // No prefix for default locale
});

// Type for locales
export type Locale = (typeof routing.locales)[number];
```

**src/i18n/navigation.ts** - Create localized navigation APIs:
```typescript
import { createNavigation } from 'next-intl/navigation';
import { routing } from './routing';

// Export localized navigation components and hooks
export const { Link, redirect, usePathname, useRouter, getPathname } =
  createNavigation(routing);
```

**src/i18n/request.ts** - Request configuration for server components:
```typescript
import { getRequestConfig } from 'next-intl/server';
import { hasLocale } from 'next-intl';
import { routing } from './routing';

export default getRequestConfig(async ({ requestLocale }) => {
  // Get requested locale
  const requested = await requestLocale;

  // Validate locale, fallback to default
  const locale = hasLocale(routing.locales, requested)
    ? requested
    : routing.defaultLocale;

  return {
    locale,
    messages: (await import(`../messages/${locale}.json`)).default
  };
});
```

**next.config.ts** - Add next-intl plugin:
```typescript
import type { NextConfig } from 'next';
import createNextIntlPlugin from 'next-intl/plugin';

const withNextIntl = createNextIntlPlugin('./src/i18n/request.ts');

const nextConfig: NextConfig = {
  experimental: {
    serverActions: {
      bodySizeLimit: '2mb',
    },
  },
};

export default withNextIntl(nextConfig);
```
  </action>
  <verify>
Files exist: `ls src/i18n/`
TypeScript compiles: `npm run build` (may fail due to missing messages, that's expected)
  </verify>
  <done>
next-intl routing configured with 4 locales (es, en, de, fr). Navigation helpers exported. Request config ready for server components.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create translation files for all 4 languages</name>
  <files>
    - src/messages/es.json
    - src/messages/en.json
    - src/messages/de.json
    - src/messages/fr.json
  </files>
  <action>
Create the messages directory and translation files:

**src/messages/es.json** - Spanish (default):
```json
{
  "common": {
    "appName": "JL Taxes",
    "loading": "Cargando...",
    "error": "Ha ocurrido un error",
    "save": "Guardar",
    "cancel": "Cancelar",
    "continue": "Continuar",
    "back": "Volver",
    "submit": "Enviar"
  },
  "nav": {
    "home": "Inicio",
    "login": "Iniciar sesion",
    "register": "Registrarse",
    "logout": "Cerrar sesion",
    "dashboard": "Panel"
  },
  "auth": {
    "loginTitle": "Iniciar sesion",
    "loginSubtitle": "Accede a tu cuenta para gestionar tus declaraciones",
    "registerTitle": "Crear cuenta",
    "registerSubtitle": "Registrate para empezar a declarar tus impuestos",
    "resetPasswordTitle": "Recuperar contrasena",
    "resetPasswordSubtitle": "Te enviaremos un enlace para restablecer tu contrasena",
    "email": "Correo electronico",
    "password": "Contrasena",
    "confirmPassword": "Confirmar contrasena",
    "forgotPassword": "He olvidado mi contrasena",
    "noAccount": "No tienes cuenta?",
    "hasAccount": "Ya tienes cuenta?",
    "signIn": "Iniciar sesion",
    "signUp": "Crear cuenta",
    "sendResetLink": "Enviar enlace",
    "backToLogin": "Volver a iniciar sesion",
    "confirmationEmailSent": "Te hemos enviado un email de confirmacion",
    "resetEmailSent": "Te hemos enviado un enlace para restablecer tu contrasena",
    "signUpError": "Error al crear la cuenta",
    "signInError": "Email o contrasena incorrectos",
    "resetError": "Error al enviar el email"
  },
  "validation": {
    "emailRequired": "El email es obligatorio",
    "emailInvalid": "Introduce un email valido",
    "passwordRequired": "La contrasena es obligatoria",
    "passwordMinLength": "La contrasena debe tener al menos 8 caracteres",
    "confirmPasswordRequired": "Confirma tu contrasena",
    "passwordsMustMatch": "Las contrasenas no coinciden"
  },
  "home": {
    "title": "Bienvenido a JL Taxes",
    "subtitle": "Gestiona tus declaraciones del Modelo 210 de forma sencilla",
    "cta": "Empezar ahora"
  },
  "language": {
    "select": "Idioma",
    "es": "Espanol",
    "en": "English",
    "de": "Deutsch",
    "fr": "Francais"
  }
}
```

**src/messages/en.json** - English:
```json
{
  "common": {
    "appName": "JL Taxes",
    "loading": "Loading...",
    "error": "An error occurred",
    "save": "Save",
    "cancel": "Cancel",
    "continue": "Continue",
    "back": "Back",
    "submit": "Submit"
  },
  "nav": {
    "home": "Home",
    "login": "Log in",
    "register": "Register",
    "logout": "Log out",
    "dashboard": "Dashboard"
  },
  "auth": {
    "loginTitle": "Log in",
    "loginSubtitle": "Access your account to manage your tax declarations",
    "registerTitle": "Create account",
    "registerSubtitle": "Register to start filing your taxes",
    "resetPasswordTitle": "Reset password",
    "resetPasswordSubtitle": "We will send you a link to reset your password",
    "email": "Email address",
    "password": "Password",
    "confirmPassword": "Confirm password",
    "forgotPassword": "Forgot your password?",
    "noAccount": "Don't have an account?",
    "hasAccount": "Already have an account?",
    "signIn": "Log in",
    "signUp": "Create account",
    "sendResetLink": "Send reset link",
    "backToLogin": "Back to login",
    "confirmationEmailSent": "We have sent you a confirmation email",
    "resetEmailSent": "We have sent you a password reset link",
    "signUpError": "Error creating account",
    "signInError": "Invalid email or password",
    "resetError": "Error sending reset email"
  },
  "validation": {
    "emailRequired": "Email is required",
    "emailInvalid": "Please enter a valid email",
    "passwordRequired": "Password is required",
    "passwordMinLength": "Password must be at least 8 characters",
    "confirmPasswordRequired": "Please confirm your password",
    "passwordsMustMatch": "Passwords do not match"
  },
  "home": {
    "title": "Welcome to JL Taxes",
    "subtitle": "Manage your Modelo 210 declarations easily",
    "cta": "Get started"
  },
  "language": {
    "select": "Language",
    "es": "Espanol",
    "en": "English",
    "de": "Deutsch",
    "fr": "Francais"
  }
}
```

**src/messages/de.json** - German:
```json
{
  "common": {
    "appName": "JL Taxes",
    "loading": "Laden...",
    "error": "Ein Fehler ist aufgetreten",
    "save": "Speichern",
    "cancel": "Abbrechen",
    "continue": "Weiter",
    "back": "Zuruck",
    "submit": "Absenden"
  },
  "nav": {
    "home": "Startseite",
    "login": "Anmelden",
    "register": "Registrieren",
    "logout": "Abmelden",
    "dashboard": "Dashboard"
  },
  "auth": {
    "loginTitle": "Anmelden",
    "loginSubtitle": "Melden Sie sich an, um Ihre Steuererklarungen zu verwalten",
    "registerTitle": "Konto erstellen",
    "registerSubtitle": "Registrieren Sie sich, um Ihre Steuern einzureichen",
    "resetPasswordTitle": "Passwort zurucksetzen",
    "resetPasswordSubtitle": "Wir senden Ihnen einen Link zum Zurucksetzen Ihres Passworts",
    "email": "E-Mail-Adresse",
    "password": "Passwort",
    "confirmPassword": "Passwort bestatigen",
    "forgotPassword": "Passwort vergessen?",
    "noAccount": "Noch kein Konto?",
    "hasAccount": "Bereits ein Konto?",
    "signIn": "Anmelden",
    "signUp": "Registrieren",
    "sendResetLink": "Link senden",
    "backToLogin": "Zuruck zur Anmeldung",
    "confirmationEmailSent": "Wir haben Ihnen eine Bestatigungs-E-Mail gesendet",
    "resetEmailSent": "Wir haben Ihnen einen Link zum Zurucksetzen gesendet",
    "signUpError": "Fehler beim Erstellen des Kontos",
    "signInError": "Ungultige E-Mail oder Passwort",
    "resetError": "Fehler beim Senden der E-Mail"
  },
  "validation": {
    "emailRequired": "E-Mail ist erforderlich",
    "emailInvalid": "Bitte geben Sie eine gultige E-Mail ein",
    "passwordRequired": "Passwort ist erforderlich",
    "passwordMinLength": "Passwort muss mindestens 8 Zeichen haben",
    "confirmPasswordRequired": "Bitte bestatigen Sie Ihr Passwort",
    "passwordsMustMatch": "Passworter stimmen nicht uberein"
  },
  "home": {
    "title": "Willkommen bei JL Taxes",
    "subtitle": "Verwalten Sie Ihre Modelo 210 Erklarungen einfach",
    "cta": "Jetzt starten"
  },
  "language": {
    "select": "Sprache",
    "es": "Espanol",
    "en": "English",
    "de": "Deutsch",
    "fr": "Francais"
  }
}
```

**src/messages/fr.json** - French:
```json
{
  "common": {
    "appName": "JL Taxes",
    "loading": "Chargement...",
    "error": "Une erreur est survenue",
    "save": "Enregistrer",
    "cancel": "Annuler",
    "continue": "Continuer",
    "back": "Retour",
    "submit": "Envoyer"
  },
  "nav": {
    "home": "Accueil",
    "login": "Connexion",
    "register": "Inscription",
    "logout": "Deconnexion",
    "dashboard": "Tableau de bord"
  },
  "auth": {
    "loginTitle": "Connexion",
    "loginSubtitle": "Accedez a votre compte pour gerer vos declarations fiscales",
    "registerTitle": "Creer un compte",
    "registerSubtitle": "Inscrivez-vous pour commencer a declarer vos impots",
    "resetPasswordTitle": "Reinitialiser le mot de passe",
    "resetPasswordSubtitle": "Nous vous enverrons un lien pour reinitialiser votre mot de passe",
    "email": "Adresse e-mail",
    "password": "Mot de passe",
    "confirmPassword": "Confirmer le mot de passe",
    "forgotPassword": "Mot de passe oublie?",
    "noAccount": "Pas encore de compte?",
    "hasAccount": "Deja un compte?",
    "signIn": "Se connecter",
    "signUp": "Creer un compte",
    "sendResetLink": "Envoyer le lien",
    "backToLogin": "Retour a la connexion",
    "confirmationEmailSent": "Nous vous avons envoye un email de confirmation",
    "resetEmailSent": "Nous vous avons envoye un lien de reinitialisation",
    "signUpError": "Erreur lors de la creation du compte",
    "signInError": "Email ou mot de passe invalide",
    "resetError": "Erreur lors de l'envoi de l'email"
  },
  "validation": {
    "emailRequired": "L'email est requis",
    "emailInvalid": "Veuillez entrer un email valide",
    "passwordRequired": "Le mot de passe est requis",
    "passwordMinLength": "Le mot de passe doit contenir au moins 8 caracteres",
    "confirmPasswordRequired": "Veuillez confirmer votre mot de passe",
    "passwordsMustMatch": "Les mots de passe ne correspondent pas"
  },
  "home": {
    "title": "Bienvenue sur JL Taxes",
    "subtitle": "Gerez vos declarations Modelo 210 facilement",
    "cta": "Commencer"
  },
  "language": {
    "select": "Langue",
    "es": "Espanol",
    "en": "English",
    "de": "Deutsch",
    "fr": "Francais"
  }
}
```
  </action>
  <verify>
Files exist: `ls src/messages/`
JSON syntax valid: `cat src/messages/es.json | npx json -o json-0` (should not error)
All files have same structure (same keys)
  </verify>
  <done>
Translation files created for all 4 languages (es, en, de, fr). All have consistent structure with common, nav, auth, validation, home, and language namespaces.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create middleware and locale layout</name>
  <files>
    - src/middleware.ts
    - src/app/[locale]/layout.tsx
    - src/app/[locale]/page.tsx
    - src/app/layout.tsx (remove or redirect)
  </files>
  <action>
**src/middleware.ts** - Combined i18n middleware (auth will be added in Plan 04):
```typescript
import createMiddleware from 'next-intl/middleware';
import { routing } from './i18n/routing';

export default createMiddleware(routing);

export const config = {
  // Match all pathnames except static files and API routes
  matcher: ['/', '/(es|en|de|fr)/:path*']
};
```

**src/app/[locale]/layout.tsx** - Root layout with i18n provider:
```typescript
import { NextIntlClientProvider } from 'next-intl';
import { getMessages, setRequestLocale } from 'next-intl/server';
import { notFound } from 'next/navigation';
import { routing, type Locale } from '@/i18n/routing';
import '../globals.css';

export function generateStaticParams() {
  return routing.locales.map((locale) => ({ locale }));
}

export default async function LocaleLayout({
  children,
  params,
}: {
  children: React.ReactNode;
  params: Promise<{ locale: string }>;
}) {
  const { locale } = await params;

  // Validate locale
  if (!routing.locales.includes(locale as Locale)) {
    notFound();
  }

  // Enable static rendering
  setRequestLocale(locale);

  // Get messages for client provider
  const messages = await getMessages();

  return (
    <html lang={locale}>
      <body className="antialiased">
        <NextIntlClientProvider messages={messages}>
          {children}
        </NextIntlClientProvider>
      </body>
    </html>
  );
}
```

**src/app/[locale]/page.tsx** - Home page with translations:
```typescript
import { useTranslations } from 'next-intl';
import { setRequestLocale } from 'next-intl/server';
import { Link } from '@/i18n/navigation';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';

export default async function HomePage({
  params,
}: {
  params: Promise<{ locale: string }>;
}) {
  const { locale } = await params;
  setRequestLocale(locale);

  return <HomeContent />;
}

function HomeContent() {
  const t = useTranslations();

  return (
    <main className="min-h-screen p-8">
      <div className="mx-auto max-w-2xl space-y-8">
        {/* Header */}
        <div className="text-center space-y-4">
          <h1 className="text-2xl font-bold">{t('home.title')}</h1>
          <p className="text-muted-foreground">{t('home.subtitle')}</p>
        </div>

        {/* Language switcher demo */}
        <Card>
          <CardHeader>
            <CardTitle>{t('language.select')}</CardTitle>
            <CardDescription>
              I18N-01 to I18N-04: 4 languages supported
            </CardDescription>
          </CardHeader>
          <CardContent className="flex flex-wrap gap-4">
            <Button variant="outline" asChild>
              <Link href="/" locale="es">{t('language.es')}</Link>
            </Button>
            <Button variant="outline" asChild>
              <Link href="/" locale="en">{t('language.en')}</Link>
            </Button>
            <Button variant="outline" asChild>
              <Link href="/" locale="de">{t('language.de')}</Link>
            </Button>
            <Button variant="outline" asChild>
              <Link href="/" locale="fr">{t('language.fr')}</Link>
            </Button>
          </CardContent>
        </Card>

        {/* Auth navigation demo */}
        <Card>
          <CardHeader>
            <CardTitle>{t('nav.home')}</CardTitle>
            <CardDescription>
              Navigation links (auth pages in Plan 04)
            </CardDescription>
          </CardHeader>
          <CardContent className="flex flex-wrap gap-4">
            <Button asChild>
              <Link href="/login">{t('nav.login')}</Link>
            </Button>
            <Button variant="secondary" asChild>
              <Link href="/register">{t('nav.register')}</Link>
            </Button>
          </CardContent>
        </Card>

        {/* CTA */}
        <div className="text-center">
          <Button size="lg" asChild>
            <Link href="/register">{t('home.cta')}</Link>
          </Button>
        </div>
      </div>
    </main>
  );
}
```

**Remove or update src/app/layout.tsx** - Delete the root layout since we use [locale]/layout.tsx:
```bash
# Delete the root layout (locale layout handles everything)
rm src/app/layout.tsx
```

If the app needs a root layout.tsx for metadata, create a minimal one:
```typescript
// src/app/layout.tsx (minimal, just for metadata)
import type { Metadata } from 'next';

export const metadata: Metadata = {
  title: 'JL Taxes',
  description: 'Gestiona tus declaraciones del Modelo 210',
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return children;
}
```

Also remove `src/app/page.tsx` if it exists (the [locale]/page.tsx handles root):
```bash
rm src/app/page.tsx 2>/dev/null || true
```
  </action>
  <verify>
Run `npm run dev` and test:
1. Visit http://localhost:3000 - should redirect to /es (or show Spanish)
2. Visit http://localhost:3000/en - should show English
3. Visit http://localhost:3000/de - should show German
4. Visit http://localhost:3000/fr - should show French
5. Click language switcher buttons - should change language
6. Verify text changes when switching languages
  </verify>
  <done>
Middleware configured for locale routing. [locale] layout provides i18n context. Home page displays translations. Language switching works across all 4 locales.
  </done>
</task>

</tasks>

<verification>
1. `npm run dev` starts without errors
2. Visiting / redirects to default locale or shows Spanish content
3. Visiting /es, /en, /de, /fr shows respective language content
4. Language switcher buttons work
5. All UI text is translated (no hardcoded English)
6. `npm run build` completes (static generation works)
</verification>

<success_criteria>
- I18N-01: Spanish interface available at /es (or / as default)
- I18N-02: English interface available at /en
- I18N-03: German interface available at /de
- I18N-04: French interface available at /fr
- Locale routing works with next-intl middleware
- Translation files have consistent structure across all languages
- useTranslations hook works in components
- Language switching preserves current route
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md` following the summary template.
</output>
