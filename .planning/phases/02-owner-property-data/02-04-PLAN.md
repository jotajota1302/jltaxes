---
phase: 02-owner-property-data
plan: 04
type: execute
wave: 4
depends_on: ["02-01", "02-02", "02-03"]
files_modified:
  - src/hooks/usePropertySchemas.ts
  - src/stores/property-form.ts
  - src/app/[locale]/(protected)/properties/page.tsx
  - src/app/[locale]/(protected)/properties/new/page.tsx
  - src/app/[locale]/(protected)/properties/[id]/page.tsx
  - src/app/[locale]/(protected)/properties/actions.ts
  - src/components/properties/property-form.tsx
  - src/components/properties/property-card.tsx
  - src/components/properties/address-fields.tsx
  - src/components/properties/cadastral-input.tsx
  - src/components/properties/ownership-table.tsx
  - src/components/properties/ibi-helper.tsx
  - src/messages/es.json
  - src/messages/en.json
  - src/messages/de.json
  - src/messages/fr.json
autonomous: false

must_haves:
  truths:
    - "User can register property with complete Spanish address"
    - "User can enter and validate 20-character cadastral reference"
    - "User can enter cadastral value with visual IBI receipt guide"
    - "User can assign multiple owners with ownership percentages"
    - "System validates ownership percentages sum to 100%"
    - "Property data persists to database with owner links"
  artifacts:
    - path: "src/hooks/usePropertySchemas.ts"
      provides: "Zod schemas for property forms with cadastral validation"
      exports: ["usePropertySchema", "usePropertyAddressSchema", "usePropertyCadastralSchema"]
    - path: "src/stores/property-form.ts"
      provides: "Zustand store for multi-step property form"
      exports: ["usePropertyFormStore"]
    - path: "src/app/[locale]/(protected)/properties/actions.ts"
      provides: "Server actions for property CRUD with ownership"
      exports: ["createProperty", "updateProperty", "deleteProperty", "getProperties"]
    - path: "src/components/properties/ownership-table.tsx"
      provides: "Table for assigning owners with percentage inputs"
      min_lines: 80
    - path: "src/components/properties/ibi-helper.tsx"
      provides: "Visual guide showing where to find cadastral value on IBI receipt"
      min_lines: 50
  key_links:
    - from: "src/components/properties/ownership-table.tsx"
      to: "src/lib/validators/ownership.ts"
      via: "validation import"
      pattern: "validateOwnershipPercentages"
    - from: "src/app/[locale]/(protected)/properties/actions.ts"
      to: "src/db/schema.ts"
      via: "database insert"
      pattern: "db\\.insert.*properties|db\\.insert.*ownerProperties"
    - from: "src/components/properties/cadastral-input.tsx"
      to: "src/lib/validators/cadastral.ts"
      via: "validator import"
      pattern: "validateCadastralReference"
---

<objective>
Implement property management with Spanish address structure, cadastral reference validation, ownership percentage assignment, and visual guidance for cadastral value lookup.

Purpose: Fulfill PROP-01 through PROP-08 requirements - properties must be registered with all fiscal data for Modelo 210 declarations
Output: Complete property management feature with multi-owner assignment and 100% validation
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-owner-property-data/02-RESEARCH.md
@.planning/phases/02-owner-property-data/02-03-SUMMARY.md

# From Plan 03:
# - Owner management complete
# - getOwners() action available for ownership assignment
# - Protected layout in place

# Schema and validators:
@src/db/schema.ts
@src/lib/validators/index.ts

# Established patterns:
@src/hooks/useOwnerSchemas.ts
@src/stores/owner-form.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add property translations</name>
  <files>
    src/messages/es.json
    src/messages/en.json
    src/messages/de.json
    src/messages/fr.json
  </files>
  <action>
Add to each messages file under "property" namespace:

```json
{
  "property": {
    "title": "Propiedades",
    "addNew": "Nueva propiedad",
    "noProperties": "No hay propiedades registradas",
    "addFirst": "Registra tu primera propiedad para comenzar",

    "steps": {
      "address": "Direccion",
      "cadastral": "Catastro",
      "owners": "Propietarios"
    },

    "streetTypes": {
      "calle": "Calle",
      "avenida": "Avenida",
      "plaza": "Plaza",
      "paseo": "Paseo",
      "carretera": "Carretera",
      "camino": "Camino",
      "travesia": "Travesia",
      "urbanizacion": "Urbanizacion",
      "otro": "Otro"
    },

    "form": {
      "streetType": "Tipo de via",
      "selectStreetType": "Selecciona tipo de via",
      "streetName": "Nombre de la via",
      "streetNumber": "Numero",
      "floor": "Piso",
      "door": "Puerta",
      "staircase": "Escalera",
      "block": "Bloque",
      "city": "Municipio",
      "province": "Provincia",
      "postalCode": "Codigo postal",

      "cadastralReference": "Referencia catastral",
      "cadastralReferenceHint": "20 caracteres, aparece en tu recibo del IBI",
      "cadastralValue": "Valor catastral",
      "cadastralValueHint": "Aparece en tu recibo del IBI",
      "collectiveRevision": "Revision catastral colectiva en los ultimos 10 anos",
      "revisionYear": "Ano de revision",

      "ownershipTitle": "Propietarios y porcentajes",
      "ownershipHint": "Asigna propietarios y sus porcentajes de titularidad (deben sumar 100%)",
      "addOwner": "Anadir propietario",
      "percentage": "Porcentaje",
      "removeOwner": "Quitar propietario"
    },

    "ibiHelper": {
      "title": "Donde encontrar el valor catastral",
      "description": "El valor catastral aparece en tu recibo del IBI (Impuesto sobre Bienes Inmuebles).",
      "step1": "Busca tu recibo del IBI del ultimo ano",
      "step2": "Localiza la seccion 'Datos del inmueble'",
      "step3": "El valor catastral aparece junto a 'Valor catastral' o 'Base imponible'",
      "note": "Si no tienes el recibo, puedes consultarlo en la Sede Electronica del Catastro"
    },

    "actions": {
      "next": "Siguiente",
      "back": "Atras",
      "save": "Guardar propiedad",
      "edit": "Editar",
      "delete": "Eliminar",
      "confirmDelete": "Â¿Eliminar esta propiedad?"
    },

    "success": {
      "created": "Propiedad creada correctamente",
      "updated": "Propiedad actualizada correctamente",
      "deleted": "Propiedad eliminada"
    },

    "errors": {
      "noOwners": "Debes asignar al menos un propietario",
      "percentageNot100": "Los porcentajes deben sumar exactamente 100%"
    }
  }
}
```

Also add validation translations (extend existing):
```json
{
  "validation": {
    "streetTypeRequired": "El tipo de via es obligatorio",
    "streetNameRequired": "El nombre de la via es obligatorio",
    "streetNumberRequired": "El numero es obligatorio",
    "provinceRequired": "La provincia es obligatoria",
    "cadastralReferenceRequired": "La referencia catastral es obligatoria",
    "cadastralReferenceInvalid": "Referencia catastral invalida (debe tener 20 caracteres)",
    "cadastralValueRequired": "El valor catastral es obligatorio",
    "cadastralValueInvalid": "El valor catastral debe ser un numero positivo",
    "atLeastOneOwner": "Debes asignar al menos un propietario",
    "percentageUnder100": "Los porcentajes suman menos de 100%",
    "percentageOver100": "Los porcentajes suman mas de 100%",
    "percentageMustBePositive": "Cada porcentaje debe ser mayor que 0",
    "percentageExceeds100": "El porcentaje no puede superar 100%"
  }
}
```

Translate appropriately for en.json, de.json, fr.json.
  </action>
  <verify>
- All 4 message files have "property" namespace with complete translations
- Validation namespace extended with property-related messages
- Run: `npx tsc --noEmit` - no errors
  </verify>
  <done>
Property translations added to all 4 languages.
IBI helper text explains where to find cadastral value.
Validation messages cover all property fields.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Zod schemas, Zustand store, and form components</name>
  <files>
    src/hooks/usePropertySchemas.ts
    src/stores/property-form.ts
    src/components/properties/address-fields.tsx
    src/components/properties/cadastral-input.tsx
    src/components/properties/ownership-table.tsx
    src/components/properties/ibi-helper.tsx
    src/components/properties/property-form.tsx
    src/components/properties/property-card.tsx
  </files>
  <action>
**1. Create src/stores/property-form.ts:**
```typescript
import { create } from 'zustand';
import { persist } from 'zustand/middleware';

interface OwnershipAssignment {
  ownerId: string;
  percentage: number;
}

interface PropertyFormData {
  // Step 1: Address
  streetType: string;
  streetName: string;
  streetNumber: string;
  floor: string;
  door: string;
  staircase: string;
  block: string;
  city: string;
  province: string;
  postalCode: string;

  // Step 2: Cadastral
  cadastralReference: string;
  cadastralValue: string;
  collectiveRevision: boolean;
  revisionYear: string;

  // Step 3: Ownership
  owners: OwnershipAssignment[];
}

interface PropertyFormState {
  step: number;
  data: PropertyFormData;
  editingId: string | null;
  setStep: (step: number) => void;
  updateData: (data: Partial<PropertyFormData>) => void;
  setOwners: (owners: OwnershipAssignment[]) => void;
  setEditingId: (id: string | null) => void;
  reset: () => void;
}

const initialData: PropertyFormData = {
  streetType: '',
  streetName: '',
  streetNumber: '',
  floor: '',
  door: '',
  staircase: '',
  block: '',
  city: '',
  province: '',
  postalCode: '',
  cadastralReference: '',
  cadastralValue: '',
  collectiveRevision: false,
  revisionYear: '',
  owners: [],
};

export const usePropertyFormStore = create<PropertyFormState>()(
  persist(
    (set) => ({
      step: 1,
      data: initialData,
      editingId: null,
      setStep: (step) => set({ step }),
      updateData: (newData) =>
        set((state) => ({
          data: { ...state.data, ...newData },
        })),
      setOwners: (owners) =>
        set((state) => ({
          data: { ...state.data, owners },
        })),
      setEditingId: (id) => set({ editingId: id }),
      reset: () => set({ step: 1, data: initialData, editingId: null }),
    }),
    {
      name: 'property-form-storage',
    }
  )
);
```

**2. Create src/hooks/usePropertySchemas.ts:**
```typescript
import { z } from 'zod';
import { useTranslations } from 'next-intl';
import { validateCadastralReference } from '@/lib/validators';
import { validateOwnershipPercentages } from '@/lib/validators';

export const usePropertyAddressSchema = () => {
  const t = useTranslations('validation');

  return z.object({
    streetType: z.string().min(1, { message: t('streetTypeRequired') }),
    streetName: z.string().min(1, { message: t('streetNameRequired') }),
    streetNumber: z.string().min(1, { message: t('streetNumberRequired') }),
    floor: z.string().optional(),
    door: z.string().optional(),
    staircase: z.string().optional(),
    block: z.string().optional(),
    city: z.string().min(1, { message: t('cityRequired') }),
    province: z.string().min(1, { message: t('provinceRequired') }),
    postalCode: z.string().min(5, { message: t('postalCodeRequired') }).max(5),
  });
};

export const usePropertyCadastralSchema = () => {
  const t = useTranslations('validation');

  return z.object({
    cadastralReference: z
      .string()
      .min(1, { message: t('cadastralReferenceRequired') })
      .refine(validateCadastralReference, { message: t('cadastralReferenceInvalid') }),
    cadastralValue: z
      .string()
      .min(1, { message: t('cadastralValueRequired') })
      .refine((val) => !isNaN(parseFloat(val)) && parseFloat(val) > 0, {
        message: t('cadastralValueInvalid'),
      }),
    collectiveRevision: z.boolean(),
    revisionYear: z.string().optional(),
  });
};

export const usePropertyOwnershipSchema = () => {
  const t = useTranslations('validation');

  return z.object({
    owners: z
      .array(z.object({
        ownerId: z.string().uuid(),
        percentage: z.number().positive().max(100),
      }))
      .min(1, { message: t('atLeastOneOwner') })
      .refine(
        (owners) => validateOwnershipPercentages(owners).valid,
        (owners) => ({
          message: t(validateOwnershipPercentages(owners).errorCode || 'percentageNot100'),
        })
      ),
  });
};
```

**3. Create AddressFields component** at src/components/properties/address-fields.tsx:
Follow the pattern from 02-RESEARCH.md with:
- Street type select (dropdown)
- Street name, number inputs
- Optional floor, door, staircase, block
- City, province, postal code
- Grid layout responsive (12-col on lg, stack on mobile)

**4. Create CadastralInput component** at src/components/properties/cadastral-input.tsx:
- 20-character input with real-time validation
- Green/red border feedback (like TaxIdInput)
- Hint text about IBI receipt
- Link to IBI helper modal

**5. Create IbiHelper component** at src/components/properties/ibi-helper.tsx:
- Modal or expandable section
- Visual guide explaining where to find cadastral value on IBI receipt
- Step-by-step instructions
- Link to Catastro website for lookup

**6. Create OwnershipTable component** at src/components/properties/ownership-table.tsx:
- Select dropdown to add owner (from available owners list)
- Percentage input for each assigned owner
- Remove button per row
- Real-time total calculation
- Warning/error when total != 100%
- Accessible: proper labels, aria-describedby for errors

**7. Create PropertyForm component** at src/components/properties/property-form.tsx:
Multi-step wizard using:
- Stepper component
- usePropertyFormStore
- Step 1: Address fields
- Step 2: Cadastral data with IBI helper
- Step 3: Ownership assignment with validation
- Navigation: Back/Next/Save

**8. Create PropertyCard component** at src/components/properties/property-card.tsx:
- Display property address summary
- Show cadastral reference
- Show assigned owners with percentages
- Edit/delete actions
  </action>
  <verify>
Run: `npx tsc --noEmit` - no TypeScript errors
Confirm: OwnershipTable validates percentages sum to 100%
Confirm: CadastralInput uses validateCadastralReference
Confirm: IbiHelper provides visual guidance
  </verify>
  <done>
Property form components created with:
- Address fields following Spanish structure
- Cadastral validation with 20-character checksum
- IBI receipt visual guide for cadastral value
- Ownership table with 100% validation
- Multi-step wizard with persistence
  </done>
</task>

<task type="auto">
  <name>Task 3: Create property pages and server actions</name>
  <files>
    src/app/[locale]/(protected)/properties/page.tsx
    src/app/[locale]/(protected)/properties/new/page.tsx
    src/app/[locale]/(protected)/properties/[id]/page.tsx
    src/app/[locale]/(protected)/properties/actions.ts
  </files>
  <action>
**1. Create server actions** at src/app/[locale]/(protected)/properties/actions.ts:

```typescript
'use server';

import { revalidatePath } from 'next/cache';
import { createClient } from '@/lib/supabase/server';
import { db } from '@/db';
import { properties, ownerProperties, owners } from '@/db/schema';
import { eq, and } from 'drizzle-orm';
import { validateCadastralReference, normalizeCadastralReference } from '@/lib/validators';
import { validateOwnershipPercentages } from '@/lib/validators';

interface OwnershipInput {
  ownerId: string;
  percentage: number;
}

interface PropertyInput {
  streetType: string;
  streetName: string;
  streetNumber: string;
  floor?: string;
  door?: string;
  staircase?: string;
  block?: string;
  city: string;
  province: string;
  postalCode: string;
  cadastralReference: string;
  cadastralValue: string;
  collectiveRevision: boolean;
  revisionYear?: string;
  owners: OwnershipInput[];
}

export async function createProperty(data: PropertyInput) {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    return { error: 'Unauthorized' };
  }

  // Validate cadastral reference
  if (!validateCadastralReference(data.cadastralReference)) {
    return { error: 'Invalid cadastral reference' };
  }

  // Validate ownership percentages
  const ownershipValidation = validateOwnershipPercentages(data.owners);
  if (!ownershipValidation.valid) {
    return { error: ownershipValidation.errorCode || 'Invalid ownership' };
  }

  try {
    // Insert property
    const [property] = await db.insert(properties).values({
      userId: user.id,
      streetType: data.streetType as any, // enum type
      streetName: data.streetName,
      streetNumber: data.streetNumber,
      floor: data.floor || null,
      door: data.door || null,
      staircase: data.staircase || null,
      block: data.block || null,
      city: data.city,
      province: data.province,
      postalCode: data.postalCode,
      cadastralReference: normalizeCadastralReference(data.cadastralReference),
      cadastralValue: data.cadastralValue,
      collectiveRevision: data.collectiveRevision,
      revisionYear: data.revisionYear ? parseInt(data.revisionYear) : null,
    }).returning();

    // Insert ownership records
    if (data.owners.length > 0) {
      await db.insert(ownerProperties).values(
        data.owners.map((o) => ({
          ownerId: o.ownerId,
          propertyId: property.id,
          ownershipPercentage: o.percentage.toString(),
        }))
      );
    }

    revalidatePath('/properties');
    return { success: true, property };
  } catch (error) {
    console.error('Error creating property:', error);
    return { error: 'Failed to create property' };
  }
}

export async function updateProperty(id: string, data: PropertyInput) {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    return { error: 'Unauthorized' };
  }

  // Validate cadastral reference
  if (!validateCadastralReference(data.cadastralReference)) {
    return { error: 'Invalid cadastral reference' };
  }

  // Validate ownership percentages
  const ownershipValidation = validateOwnershipPercentages(data.owners);
  if (!ownershipValidation.valid) {
    return { error: ownershipValidation.errorCode || 'Invalid ownership' };
  }

  try {
    // Update property
    const [property] = await db.update(properties)
      .set({
        streetType: data.streetType as any,
        streetName: data.streetName,
        streetNumber: data.streetNumber,
        floor: data.floor || null,
        door: data.door || null,
        staircase: data.staircase || null,
        block: data.block || null,
        city: data.city,
        province: data.province,
        postalCode: data.postalCode,
        cadastralReference: normalizeCadastralReference(data.cadastralReference),
        cadastralValue: data.cadastralValue,
        collectiveRevision: data.collectiveRevision,
        revisionYear: data.revisionYear ? parseInt(data.revisionYear) : null,
        updatedAt: new Date(),
      })
      .where(and(eq(properties.id, id), eq(properties.userId, user.id)))
      .returning();

    // Delete existing ownership records
    await db.delete(ownerProperties)
      .where(eq(ownerProperties.propertyId, id));

    // Insert new ownership records
    if (data.owners.length > 0) {
      await db.insert(ownerProperties).values(
        data.owners.map((o) => ({
          ownerId: o.ownerId,
          propertyId: property.id,
          ownershipPercentage: o.percentage.toString(),
        }))
      );
    }

    revalidatePath('/properties');
    return { success: true, property };
  } catch (error) {
    console.error('Error updating property:', error);
    return { error: 'Failed to update property' };
  }
}

export async function deleteProperty(id: string) {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    return { error: 'Unauthorized' };
  }

  try {
    // Ownership records deleted by cascade
    await db.delete(properties)
      .where(and(eq(properties.id, id), eq(properties.userId, user.id)));

    revalidatePath('/properties');
    return { success: true };
  } catch (error) {
    console.error('Error deleting property:', error);
    return { error: 'Failed to delete property' };
  }
}

export async function getProperties() {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    return [];
  }

  // Get properties with their ownership records
  const propertyList = await db.select().from(properties)
    .where(eq(properties.userId, user.id));

  // Get ownership for each property
  const results = await Promise.all(
    propertyList.map(async (property) => {
      const ownerships = await db.select({
        ownershipPercentage: ownerProperties.ownershipPercentage,
        ownerId: ownerProperties.ownerId,
        ownerName: owners.firstName,
        ownerLastName: owners.lastName,
        companyName: owners.companyName,
        ownerType: owners.ownerType,
      })
        .from(ownerProperties)
        .innerJoin(owners, eq(ownerProperties.ownerId, owners.id))
        .where(eq(ownerProperties.propertyId, property.id));

      return { ...property, owners: ownerships };
    })
  );

  return results;
}

export async function getPropertyById(id: string) {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    return null;
  }

  const [property] = await db.select()
    .from(properties)
    .where(and(eq(properties.id, id), eq(properties.userId, user.id)));

  if (!property) {
    return null;
  }

  const ownerships = await db.select({
    ownershipPercentage: ownerProperties.ownershipPercentage,
    ownerId: ownerProperties.ownerId,
  })
    .from(ownerProperties)
    .where(eq(ownerProperties.propertyId, id));

  return { ...property, owners: ownerships };
}
```

**2. Create pages:**
- properties/page.tsx: List all properties with owner summaries
- properties/new/page.tsx: New property wizard
- properties/[id]/page.tsx: Edit existing property

Pages must:
- Use setRequestLocale() for static rendering
- Fetch available owners for ownership table
- Display ownership percentages in list view
- Show cadastral reference formatted
  </action>
  <verify>
Run: `npx tsc --noEmit` - no TypeScript errors
Run: `npm run build` - build succeeds
Verify: Server actions create property AND ownership records atomically
Verify: Update replaces ownership records (delete + insert)
Verify: Delete cascades to ownership records
  </verify>
  <done>
Property management feature complete with:
- CRUD server actions with ownership
- Atomic property + ownership creation
- Ownership percentage validation (100% sum)
- List, create, edit pages
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete owner and property management feature:
- Owner registration with NIE/NIF validation
- Property registration with Spanish address
- Cadastral reference validation
- IBI receipt visual guide for cadastral value
- Multi-owner assignment with 100% validation
  </what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`
2. Log in to the application
3. Navigate to /owners and create a new owner:
   - Select Individual or Company type
   - Enter NIE (e.g., X1234567L) - verify real-time validation
   - Enter fiscal residence details
   - Enter IBAN (optional) - verify format validation
   - Complete wizard and verify owner saved

4. Navigate to /properties and create a property:
   - Enter Spanish address (calle, numero, etc.)
   - Enter cadastral reference (20 chars) - verify validation
   - View IBI helper for cadastral value guidance
   - Assign owner(s) with percentages
   - Verify: cannot save if percentages != 100%
   - Complete wizard and verify property saved

5. Verify multi-owner scenario:
   - Create second owner
   - Edit property and assign both owners
   - Set 50% / 50% - verify saves
   - Try 60% / 50% - verify error shown

6. Verify data persistence:
   - Refresh page - owners and properties still show
   - Edit owner - data pre-filled
   - Edit property - owners and percentages pre-filled

7. Test all 4 languages (switch via URL: /en/owners, /de/owners, etc.)
  </how-to-verify>
  <resume-signal>
Type "approved" if all verification steps pass.
If issues found, describe what needs fixing.
  </resume-signal>
</task>

</tasks>

<verification>
1. Run `npm run build` - no build errors
2. Owner CRUD: create, read, update, delete with validation
3. Property CRUD: create, read, update, delete with validation
4. Cadastral reference: 20-character checksum validation works
5. IBI helper: visual guide displays correctly
6. Ownership: 2+ owners can be assigned
7. Ownership: percentages must sum to 100% (validated client + server)
8. Data persists: page refresh shows saved data
9. i18n: all text translates in es/en/de/fr
</verification>

<success_criteria>
Requirements delivered:
- PROP-01: User can register property in Spain
- PROP-02: Complete Spanish address with tipo via, etc.
- PROP-03: 20-character cadastral reference with validation
- PROP-04: Cadastral value with IBI visual guide
- PROP-05: Cadastral reference format validation
- PROP-06: Multiple owners with percentages
- PROP-07: Percentages sum to 100% validation
- PROP-08: Property data persists for reuse

Combined with Plan 03:
- OWNER-01 through OWNER-07 also delivered
</success_criteria>

<output>
After completion, create `.planning/phases/02-owner-property-data/02-04-SUMMARY.md`
</output>
