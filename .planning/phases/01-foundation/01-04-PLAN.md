---
phase: 01-foundation
plan: 04
type: execute
wave: 3
depends_on: ["01-02", "01-03"]
files_modified:
  - src/middleware.ts
  - src/app/[locale]/(auth)/login/page.tsx
  - src/app/[locale]/(auth)/login/actions.ts
  - src/app/[locale]/(auth)/register/page.tsx
  - src/app/[locale]/(auth)/register/actions.ts
  - src/app/[locale]/(auth)/reset-password/page.tsx
  - src/app/[locale]/(auth)/reset-password/actions.ts
  - src/app/[locale]/(auth)/reset-password/update/page.tsx
  - src/app/[locale]/(auth)/auth/confirm/route.ts
  - src/hooks/useAuthSchemas.ts
  - src/components/auth/login-form.tsx
  - src/components/auth/register-form.tsx
  - src/components/auth/reset-password-form.tsx
  - src/components/auth/language-selector.tsx
autonomous: false
user_setup:
  - service: supabase
    why: "Authentication and email templates"
    env_vars:
      - name: NEXT_PUBLIC_SUPABASE_URL
        source: "Supabase Dashboard > Project Settings > API"
      - name: NEXT_PUBLIC_SUPABASE_ANON_KEY
        source: "Supabase Dashboard > Project Settings > API"
    dashboard_config:
      - task: "Configure email templates for 4 languages"
        location: "Supabase Dashboard > Authentication > Email Templates"
      - task: "Set Site URL for redirects"
        location: "Supabase Dashboard > Authentication > URL Configuration"

must_haves:
  truths:
    - "User can register with email and password"
    - "User can log in with valid credentials"
    - "User can request password reset and receive email"
    - "User can update password via reset link"
    - "Session persists across page reloads (30+ days)"
    - "Auth forms show translated validation errors"
    - "User can select preferred language during registration"
  artifacts:
    - path: "src/app/[locale]/(auth)/login/page.tsx"
      provides: "Login page"
      contains: "LoginForm"
    - path: "src/app/[locale]/(auth)/register/page.tsx"
      provides: "Registration page"
      contains: "RegisterForm"
    - path: "src/app/[locale]/(auth)/reset-password/page.tsx"
      provides: "Password reset request page"
      contains: "ResetPasswordForm"
    - path: "src/middleware.ts"
      provides: "Combined auth + i18n middleware"
      contains: "supabase"
    - path: "src/hooks/useAuthSchemas.ts"
      provides: "Zod schemas with i18n errors"
      exports: ["useLoginSchema", "useRegisterSchema"]
  key_links:
    - from: "src/app/[locale]/(auth)/login/actions.ts"
      to: "supabase.auth.signInWithPassword"
      via: "server action"
      pattern: "signInWithPassword"
    - from: "src/app/[locale]/(auth)/register/actions.ts"
      to: "supabase.auth.signUp"
      via: "server action"
      pattern: "signUp"
    - from: "src/middleware.ts"
      to: "supabase.auth.getUser"
      via: "session refresh"
      pattern: "getUser"
---

<objective>
Implement complete authentication flow with Supabase: registration, login, password reset, and session management with 30+ day persistence.

Purpose: Deliver AUTH-01 to AUTH-05 requirements - users can create accounts, log in, recover passwords, select language, and remain logged in for 30+ days without re-authentication.

Output: Working auth pages (login, register, reset-password), server actions, combined middleware (auth + i18n), and form components with translated validation messages.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
@.planning/phases/01-foundation/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update middleware for combined auth + i18n</name>
  <files>
    - src/middleware.ts
    - src/lib/supabase/middleware.ts
  </files>
  <action>
Create middleware client utility:

**src/lib/supabase/middleware.ts**:
```typescript
import { createServerClient } from '@supabase/ssr';
import { NextResponse, type NextRequest } from 'next/server';

export async function updateSession(request: NextRequest, response: NextResponse) {
  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return request.cookies.getAll();
        },
        setAll(cookiesToSet) {
          cookiesToSet.forEach(({ name, value, options }) => {
            request.cookies.set(name, value);
            response.cookies.set(name, value, options);
          });
        },
      },
    }
  );

  // IMPORTANT: Use getUser() not getSession() for security
  // getUser() validates the JWT with Supabase Auth server
  // getSession() only reads local data and can be spoofed
  const { data: { user } } = await supabase.auth.getUser();

  return { supabase, user, response };
}
```

Update **src/middleware.ts** to combine i18n and auth:
```typescript
import { type NextRequest, NextResponse } from 'next/server';
import createIntlMiddleware from 'next-intl/middleware';
import { routing } from './i18n/routing';
import { updateSession } from './lib/supabase/middleware';

const handleI18nRouting = createIntlMiddleware(routing);

export async function middleware(request: NextRequest) {
  // Step 1: Handle i18n routing first (creates response with locale)
  const response = handleI18nRouting(request);

  // Step 2: Update Supabase session (refreshes tokens via cookies)
  await updateSession(request, response);

  // Future: Add protected route logic here
  // const { user } = await updateSession(request, response);
  // if (protectedRoutes.includes(pathname) && !user) {
  //   return NextResponse.redirect(new URL('/login', request.url));
  // }

  return response;
}

export const config = {
  matcher: [
    // Match all pathnames except static files
    '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',
  ],
};
```

CRITICAL NOTES:
- Always use `getUser()` not `getSession()` in middleware for security
- Cookie sync must update BOTH request and response cookies
- Session refresh happens automatically on every request
  </action>
  <verify>
Run `npm run dev` - server should start without middleware errors.
Check browser DevTools > Application > Cookies - should see `sb-*` cookies after visiting a page.
  </verify>
  <done>
Combined middleware handles i18n routing and Supabase session refresh. Uses secure getUser() pattern. Cookies synced correctly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create auth form schemas with i18n validation messages</name>
  <files>
    - src/hooks/useAuthSchemas.ts
  </files>
  <action>
Create **src/hooks/useAuthSchemas.ts**:
```typescript
'use client';

import { z } from 'zod';
import { useTranslations } from 'next-intl';

/**
 * Login schema with translated error messages
 * IMPORTANT: Must be created inside a component/hook to access translations
 */
export const useLoginSchema = () => {
  const t = useTranslations('validation');

  return z.object({
    email: z
      .string()
      .min(1, { message: t('emailRequired') })
      .email({ message: t('emailInvalid') }),
    password: z
      .string()
      .min(1, { message: t('passwordRequired') }),
  });
};

/**
 * Registration schema with translated error messages
 * Includes password confirmation validation
 */
export const useRegisterSchema = () => {
  const t = useTranslations('validation');

  return z.object({
    email: z
      .string()
      .min(1, { message: t('emailRequired') })
      .email({ message: t('emailInvalid') }),
    password: z
      .string()
      .min(8, { message: t('passwordMinLength') }),
    confirmPassword: z
      .string()
      .min(1, { message: t('confirmPasswordRequired') }),
  }).refine((data) => data.password === data.confirmPassword, {
    message: t('passwordsMustMatch'),
    path: ['confirmPassword'],
  });
};

/**
 * Password reset request schema
 */
export const useResetPasswordSchema = () => {
  const t = useTranslations('validation');

  return z.object({
    email: z
      .string()
      .min(1, { message: t('emailRequired') })
      .email({ message: t('emailInvalid') }),
  });
};

/**
 * Update password schema (after clicking reset link)
 */
export const useUpdatePasswordSchema = () => {
  const t = useTranslations('validation');

  return z.object({
    password: z
      .string()
      .min(8, { message: t('passwordMinLength') }),
    confirmPassword: z
      .string()
      .min(1, { message: t('confirmPasswordRequired') }),
  }).refine((data) => data.password === data.confirmPassword, {
    message: t('passwordsMustMatch'),
    path: ['confirmPassword'],
  });
};

// Export types for form data
export type LoginFormData = z.infer<ReturnType<typeof useLoginSchema>>;
export type RegisterFormData = z.infer<ReturnType<typeof useRegisterSchema>>;
export type ResetPasswordFormData = z.infer<ReturnType<typeof useResetPasswordSchema>>;
export type UpdatePasswordFormData = z.infer<ReturnType<typeof useUpdatePasswordSchema>>;
```

IMPORTANT: Zod schemas MUST be created inside React components/hooks (not at module level) to use translations. This is a common pitfall - see research document.
  </action>
  <verify>
TypeScript should compile: `npx tsc --noEmit`
Hooks export correctly from the file.
  </verify>
  <done>
Auth schemas created with i18n-aware validation messages. Schemas are factory hooks that can be called inside components.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create auth pages and server actions</name>
  <files>
    - src/app/[locale]/(auth)/login/page.tsx
    - src/app/[locale]/(auth)/login/actions.ts
    - src/app/[locale]/(auth)/register/page.tsx
    - src/app/[locale]/(auth)/register/actions.ts
    - src/app/[locale]/(auth)/reset-password/page.tsx
    - src/app/[locale]/(auth)/reset-password/actions.ts
    - src/app/[locale]/(auth)/reset-password/update/page.tsx
    - src/app/[locale]/(auth)/auth/confirm/route.ts
    - src/components/auth/login-form.tsx
    - src/components/auth/register-form.tsx
    - src/components/auth/reset-password-form.tsx
    - src/components/auth/language-selector.tsx
  </files>
  <action>
Create the auth route group and pages:

**src/components/auth/language-selector.tsx**:
```typescript
'use client';

import { useLocale, useTranslations } from 'next-intl';
import { useRouter, usePathname } from '@/i18n/navigation';
import { routing } from '@/i18n/routing';
import { Button } from '@/components/ui/button';

export function LanguageSelector() {
  const locale = useLocale();
  const router = useRouter();
  const pathname = usePathname();
  const t = useTranslations('language');

  const handleChange = (newLocale: string) => {
    router.replace(pathname, { locale: newLocale });
  };

  return (
    <div className="flex flex-wrap gap-2">
      {routing.locales.map((loc) => (
        <Button
          key={loc}
          variant={loc === locale ? 'default' : 'outline'}
          size="sm"
          onClick={() => handleChange(loc)}
        >
          {t(loc)}
        </Button>
      ))}
    </div>
  );
}
```

**src/components/auth/login-form.tsx**:
```typescript
'use client';

import { useState } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { useTranslations } from 'next-intl';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Card, CardContent, CardDescription, CardHeader, CardTitle, CardFooter } from '@/components/ui/card';
import { useLoginSchema, type LoginFormData } from '@/hooks/useAuthSchemas';
import { Link } from '@/i18n/navigation';
import { login } from '@/app/[locale]/(auth)/login/actions';

export function LoginForm() {
  const t = useTranslations('auth');
  const schema = useLoginSchema();
  const [error, setError] = useState<string | null>(null);
  const [isLoading, setIsLoading] = useState(false);

  const {
    register,
    handleSubmit,
    formState: { errors },
  } = useForm<LoginFormData>({
    resolver: zodResolver(schema),
  });

  const onSubmit = async (data: LoginFormData) => {
    setIsLoading(true);
    setError(null);

    const formData = new FormData();
    formData.append('email', data.email);
    formData.append('password', data.password);

    const result = await login(formData);

    if (result?.error) {
      setError(result.error);
      setIsLoading(false);
    }
    // Success redirects, so no need to handle
  };

  return (
    <Card className="w-full max-w-md">
      <CardHeader className="space-y-1">
        <CardTitle className="text-2xl">{t('loginTitle')}</CardTitle>
        <CardDescription>{t('loginSubtitle')}</CardDescription>
      </CardHeader>
      <CardContent>
        <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
          {error && (
            <div className="p-3 text-base text-destructive bg-destructive/10 rounded-md">
              {error}
            </div>
          )}

          <div className="space-y-2">
            <Label htmlFor="email">{t('email')}</Label>
            <Input
              id="email"
              type="email"
              {...register('email')}
              aria-invalid={errors.email ? 'true' : 'false'}
            />
            {errors.email && (
              <p className="text-base text-destructive">{errors.email.message}</p>
            )}
          </div>

          <div className="space-y-2">
            <Label htmlFor="password">{t('password')}</Label>
            <Input
              id="password"
              type="password"
              {...register('password')}
              aria-invalid={errors.password ? 'true' : 'false'}
            />
            {errors.password && (
              <p className="text-base text-destructive">{errors.password.message}</p>
            )}
          </div>

          <Button type="submit" className="w-full" disabled={isLoading}>
            {isLoading ? '...' : t('signIn')}
          </Button>
        </form>
      </CardContent>
      <CardFooter className="flex flex-col space-y-4">
        <Link href="/reset-password" className="text-base text-primary hover:underline">
          {t('forgotPassword')}
        </Link>
        <p className="text-base text-muted-foreground">
          {t('noAccount')}{' '}
          <Link href="/register" className="text-primary hover:underline">
            {t('signUp')}
          </Link>
        </p>
      </CardFooter>
    </Card>
  );
}
```

**src/app/[locale]/(auth)/login/actions.ts**:
```typescript
'use server';

import { redirect } from 'next/navigation';
import { getLocale, getTranslations } from 'next-intl/server';
import { createClient } from '@/lib/supabase/server';

export async function login(formData: FormData) {
  const supabase = await createClient();
  const t = await getTranslations('auth');
  const locale = await getLocale();

  const email = formData.get('email') as string;
  const password = formData.get('password') as string;

  const { error } = await supabase.auth.signInWithPassword({
    email,
    password,
  });

  if (error) {
    return { error: t('signInError') };
  }

  // Redirect to home on success
  redirect(`/${locale}`);
}
```

**src/app/[locale]/(auth)/login/page.tsx**:
```typescript
import { setRequestLocale } from 'next-intl/server';
import { LoginForm } from '@/components/auth/login-form';
import { LanguageSelector } from '@/components/auth/language-selector';

export default async function LoginPage({
  params,
}: {
  params: Promise<{ locale: string }>;
}) {
  const { locale } = await params;
  setRequestLocale(locale);

  return (
    <main className="min-h-screen flex flex-col items-center justify-center p-8">
      <div className="mb-6">
        <LanguageSelector />
      </div>
      <LoginForm />
    </main>
  );
}
```

**src/components/auth/register-form.tsx**:
```typescript
'use client';

import { useState } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { useTranslations } from 'next-intl';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Card, CardContent, CardDescription, CardHeader, CardTitle, CardFooter } from '@/components/ui/card';
import { useRegisterSchema, type RegisterFormData } from '@/hooks/useAuthSchemas';
import { Link } from '@/i18n/navigation';
import { signUp } from '@/app/[locale]/(auth)/register/actions';

export function RegisterForm() {
  const t = useTranslations('auth');
  const schema = useRegisterSchema();
  const [error, setError] = useState<string | null>(null);
  const [success, setSuccess] = useState<string | null>(null);
  const [isLoading, setIsLoading] = useState(false);

  const {
    register,
    handleSubmit,
    formState: { errors },
  } = useForm<RegisterFormData>({
    resolver: zodResolver(schema),
  });

  const onSubmit = async (data: RegisterFormData) => {
    setIsLoading(true);
    setError(null);
    setSuccess(null);

    const formData = new FormData();
    formData.append('email', data.email);
    formData.append('password', data.password);

    const result = await signUp(formData);

    setIsLoading(false);

    if (result?.error) {
      setError(result.error);
    } else if (result?.success) {
      setSuccess(result.success);
    }
  };

  return (
    <Card className="w-full max-w-md">
      <CardHeader className="space-y-1">
        <CardTitle className="text-2xl">{t('registerTitle')}</CardTitle>
        <CardDescription>{t('registerSubtitle')}</CardDescription>
      </CardHeader>
      <CardContent>
        <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
          {error && (
            <div className="p-3 text-base text-destructive bg-destructive/10 rounded-md">
              {error}
            </div>
          )}
          {success && (
            <div className="p-3 text-base text-green-700 bg-green-100 rounded-md">
              {success}
            </div>
          )}

          <div className="space-y-2">
            <Label htmlFor="email">{t('email')}</Label>
            <Input
              id="email"
              type="email"
              {...register('email')}
              aria-invalid={errors.email ? 'true' : 'false'}
            />
            {errors.email && (
              <p className="text-base text-destructive">{errors.email.message}</p>
            )}
          </div>

          <div className="space-y-2">
            <Label htmlFor="password">{t('password')}</Label>
            <Input
              id="password"
              type="password"
              {...register('password')}
              aria-invalid={errors.password ? 'true' : 'false'}
            />
            {errors.password && (
              <p className="text-base text-destructive">{errors.password.message}</p>
            )}
          </div>

          <div className="space-y-2">
            <Label htmlFor="confirmPassword">{t('confirmPassword')}</Label>
            <Input
              id="confirmPassword"
              type="password"
              {...register('confirmPassword')}
              aria-invalid={errors.confirmPassword ? 'true' : 'false'}
            />
            {errors.confirmPassword && (
              <p className="text-base text-destructive">{errors.confirmPassword.message}</p>
            )}
          </div>

          <Button type="submit" className="w-full" disabled={isLoading}>
            {isLoading ? '...' : t('signUp')}
          </Button>
        </form>
      </CardContent>
      <CardFooter>
        <p className="text-base text-muted-foreground">
          {t('hasAccount')}{' '}
          <Link href="/login" className="text-primary hover:underline">
            {t('signIn')}
          </Link>
        </p>
      </CardFooter>
    </Card>
  );
}
```

**src/app/[locale]/(auth)/register/actions.ts**:
```typescript
'use server';

import { getLocale, getTranslations } from 'next-intl/server';
import { createClient } from '@/lib/supabase/server';

export async function signUp(formData: FormData) {
  const supabase = await createClient();
  const locale = await getLocale();
  const t = await getTranslations('auth');

  const email = formData.get('email') as string;
  const password = formData.get('password') as string;

  const { error } = await supabase.auth.signUp({
    email,
    password,
    options: {
      data: {
        // Store language for email templates (AUTH-04)
        language: locale,
        preferred_locale: locale,
      },
      emailRedirectTo: `${process.env.NEXT_PUBLIC_SITE_URL}/${locale}/auth/confirm`,
    },
  });

  if (error) {
    return { error: t('signUpError') };
  }

  return { success: t('confirmationEmailSent') };
}
```

**src/app/[locale]/(auth)/register/page.tsx**:
```typescript
import { setRequestLocale } from 'next-intl/server';
import { RegisterForm } from '@/components/auth/register-form';
import { LanguageSelector } from '@/components/auth/language-selector';

export default async function RegisterPage({
  params,
}: {
  params: Promise<{ locale: string }>;
}) {
  const { locale } = await params;
  setRequestLocale(locale);

  return (
    <main className="min-h-screen flex flex-col items-center justify-center p-8">
      <div className="mb-6">
        <LanguageSelector />
      </div>
      <RegisterForm />
    </main>
  );
}
```

**src/components/auth/reset-password-form.tsx**:
```typescript
'use client';

import { useState } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { useTranslations } from 'next-intl';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Card, CardContent, CardDescription, CardHeader, CardTitle, CardFooter } from '@/components/ui/card';
import { useResetPasswordSchema, type ResetPasswordFormData } from '@/hooks/useAuthSchemas';
import { Link } from '@/i18n/navigation';
import { requestPasswordReset } from '@/app/[locale]/(auth)/reset-password/actions';

export function ResetPasswordForm() {
  const t = useTranslations('auth');
  const schema = useResetPasswordSchema();
  const [error, setError] = useState<string | null>(null);
  const [success, setSuccess] = useState<string | null>(null);
  const [isLoading, setIsLoading] = useState(false);

  const {
    register,
    handleSubmit,
    formState: { errors },
  } = useForm<ResetPasswordFormData>({
    resolver: zodResolver(schema),
  });

  const onSubmit = async (data: ResetPasswordFormData) => {
    setIsLoading(true);
    setError(null);
    setSuccess(null);

    const formData = new FormData();
    formData.append('email', data.email);

    const result = await requestPasswordReset(formData);

    setIsLoading(false);

    if (result?.error) {
      setError(result.error);
    } else if (result?.success) {
      setSuccess(result.success);
    }
  };

  return (
    <Card className="w-full max-w-md">
      <CardHeader className="space-y-1">
        <CardTitle className="text-2xl">{t('resetPasswordTitle')}</CardTitle>
        <CardDescription>{t('resetPasswordSubtitle')}</CardDescription>
      </CardHeader>
      <CardContent>
        <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
          {error && (
            <div className="p-3 text-base text-destructive bg-destructive/10 rounded-md">
              {error}
            </div>
          )}
          {success && (
            <div className="p-3 text-base text-green-700 bg-green-100 rounded-md">
              {success}
            </div>
          )}

          <div className="space-y-2">
            <Label htmlFor="email">{t('email')}</Label>
            <Input
              id="email"
              type="email"
              {...register('email')}
              aria-invalid={errors.email ? 'true' : 'false'}
            />
            {errors.email && (
              <p className="text-base text-destructive">{errors.email.message}</p>
            )}
          </div>

          <Button type="submit" className="w-full" disabled={isLoading}>
            {isLoading ? '...' : t('sendResetLink')}
          </Button>
        </form>
      </CardContent>
      <CardFooter>
        <Link href="/login" className="text-base text-primary hover:underline">
          {t('backToLogin')}
        </Link>
      </CardFooter>
    </Card>
  );
}
```

**src/app/[locale]/(auth)/reset-password/actions.ts**:
```typescript
'use server';

import { getLocale, getTranslations } from 'next-intl/server';
import { createClient } from '@/lib/supabase/server';

export async function requestPasswordReset(formData: FormData) {
  const supabase = await createClient();
  const locale = await getLocale();
  const t = await getTranslations('auth');

  const email = formData.get('email') as string;

  // IMPORTANT: Use absolute URL for redirectTo (required by Supabase)
  const { error } = await supabase.auth.resetPasswordForEmail(email, {
    redirectTo: `${process.env.NEXT_PUBLIC_SITE_URL}/${locale}/reset-password/update`,
  });

  if (error) {
    return { error: t('resetError') };
  }

  return { success: t('resetEmailSent') };
}

export async function updatePassword(formData: FormData) {
  const supabase = await createClient();
  const t = await getTranslations('auth');

  const password = formData.get('password') as string;

  const { error } = await supabase.auth.updateUser({ password });

  if (error) {
    return { error: t('resetError') };
  }

  return { success: t('passwordUpdated') || 'Password updated successfully' };
}
```

**src/app/[locale]/(auth)/reset-password/page.tsx**:
```typescript
import { setRequestLocale } from 'next-intl/server';
import { ResetPasswordForm } from '@/components/auth/reset-password-form';
import { LanguageSelector } from '@/components/auth/language-selector';

export default async function ResetPasswordPage({
  params,
}: {
  params: Promise<{ locale: string }>;
}) {
  const { locale } = await params;
  setRequestLocale(locale);

  return (
    <main className="min-h-screen flex flex-col items-center justify-center p-8">
      <div className="mb-6">
        <LanguageSelector />
      </div>
      <ResetPasswordForm />
    </main>
  );
}
```

**src/app/[locale]/(auth)/reset-password/update/page.tsx**:
```typescript
'use client';

import { useState } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { useTranslations } from 'next-intl';
import { useRouter } from '@/i18n/navigation';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { useUpdatePasswordSchema, type UpdatePasswordFormData } from '@/hooks/useAuthSchemas';
import { updatePassword } from '@/app/[locale]/(auth)/reset-password/actions';

export default function UpdatePasswordPage() {
  const t = useTranslations('auth');
  const router = useRouter();
  const schema = useUpdatePasswordSchema();
  const [error, setError] = useState<string | null>(null);
  const [success, setSuccess] = useState<string | null>(null);
  const [isLoading, setIsLoading] = useState(false);

  const {
    register,
    handleSubmit,
    formState: { errors },
  } = useForm<UpdatePasswordFormData>({
    resolver: zodResolver(schema),
  });

  const onSubmit = async (data: UpdatePasswordFormData) => {
    setIsLoading(true);
    setError(null);

    const formData = new FormData();
    formData.append('password', data.password);

    const result = await updatePassword(formData);

    setIsLoading(false);

    if (result?.error) {
      setError(result.error);
    } else if (result?.success) {
      setSuccess(result.success);
      // Redirect to login after short delay
      setTimeout(() => router.push('/login'), 2000);
    }
  };

  return (
    <main className="min-h-screen flex items-center justify-center p-8">
      <Card className="w-full max-w-md">
        <CardHeader className="space-y-1">
          <CardTitle className="text-2xl">{t('resetPasswordTitle')}</CardTitle>
          <CardDescription>Enter your new password</CardDescription>
        </CardHeader>
        <CardContent>
          <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
            {error && (
              <div className="p-3 text-base text-destructive bg-destructive/10 rounded-md">
                {error}
              </div>
            )}
            {success && (
              <div className="p-3 text-base text-green-700 bg-green-100 rounded-md">
                {success}
              </div>
            )}

            <div className="space-y-2">
              <Label htmlFor="password">{t('password')}</Label>
              <Input
                id="password"
                type="password"
                {...register('password')}
                aria-invalid={errors.password ? 'true' : 'false'}
              />
              {errors.password && (
                <p className="text-base text-destructive">{errors.password.message}</p>
              )}
            </div>

            <div className="space-y-2">
              <Label htmlFor="confirmPassword">{t('confirmPassword')}</Label>
              <Input
                id="confirmPassword"
                type="password"
                {...register('confirmPassword')}
                aria-invalid={errors.confirmPassword ? 'true' : 'false'}
              />
              {errors.confirmPassword && (
                <p className="text-base text-destructive">{errors.confirmPassword.message}</p>
              )}
            </div>

            <Button type="submit" className="w-full" disabled={isLoading}>
              {isLoading ? '...' : t('submit')}
            </Button>
          </form>
        </CardContent>
      </Card>
    </main>
  );
}
```

**src/app/[locale]/(auth)/auth/confirm/route.ts** - Handle email confirmation callback:
```typescript
import { type NextRequest, NextResponse } from 'next/server';
import { createClient } from '@/lib/supabase/server';

export async function GET(request: NextRequest) {
  const { searchParams, origin } = new URL(request.url);
  const token_hash = searchParams.get('token_hash');
  const type = searchParams.get('type');
  const next = searchParams.get('next') ?? '/';

  if (token_hash && type) {
    const supabase = await createClient();

    const { error } = await supabase.auth.verifyOtp({
      type: type as 'email' | 'recovery' | 'invite' | 'magiclink' | 'signup',
      token_hash,
    });

    if (!error) {
      // Redirect to intended destination
      return NextResponse.redirect(`${origin}${next}`);
    }
  }

  // Redirect to error page or login on failure
  return NextResponse.redirect(`${origin}/login?error=confirmation_failed`);
}
```

Add to translation files a `passwordUpdated` key if missing:
```json
// Add to each messages/{locale}.json under "auth"
"passwordUpdated": "Contrasena actualizada correctamente" // es
"passwordUpdated": "Password updated successfully" // en
"passwordUpdated": "Passwort erfolgreich aktualisiert" // de
"passwordUpdated": "Mot de passe mis a jour avec succes" // fr
```
  </action>
  <verify>
Run `npm run dev` and test:
1. Visit /es/login - form should render in Spanish
2. Visit /en/login - form should render in English
3. Submit empty form - validation errors should appear in current language
4. Try invalid credentials - error message should appear
5. Visit /es/register - registration form should work
6. Visit /es/reset-password - reset form should render
7. Tab through form fields - focus should be visible
  </verify>
  <done>
Auth pages created: login, register, reset-password, update-password. Server actions handle Supabase auth. Forms use React Hook Form with Zod validation. All text translated. Language selector on each page.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete authentication flow with multilingual support:
- Login page with form validation
- Registration page that stores language preference
- Password reset flow (request + update)
- Session management via middleware
- Language selector on all auth pages
  </what-built>
  <how-to-verify>
1. Open http://localhost:3000/en/register
2. Register a new account with a valid email
3. Check your email for confirmation link (or check Supabase Dashboard > Authentication > Users)
4. After confirming, go to http://localhost:3000/en/login
5. Log in with your credentials
6. Verify you are redirected to the home page
7. Refresh the page - you should still be logged in (session persists)
8. Switch languages using the language selector
9. Verify all text changes to the selected language
10. Test validation by submitting empty forms - errors should be in the current language
11. Test password reset flow at /reset-password

Expected:
- All forms render with 18px+ text and 48px buttons
- Validation errors appear in the current language
- Login persists across page refreshes
- Language preference is stored during registration
  </how-to-verify>
  <resume-signal>Type "approved" if auth flow works correctly, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. `npm run dev` starts without errors
2. All auth pages render correctly (/login, /register, /reset-password)
3. Forms validate with translated error messages
4. Registration creates user in Supabase
5. Login authenticates and redirects
6. Session persists across page reloads
7. Password reset email is sent (check Supabase logs or email)
8. Language selector works on all pages
9. All text is 18px+ and buttons are 48px+ (accessibility)
</verification>

<success_criteria>
- AUTH-01: User can register with email and password
- AUTH-02: User can log in and maintain active session
- AUTH-03: User can recover password via email
- AUTH-04: User can select preferred language (ES/EN/DE/FR)
- AUTH-05: Session persists (Supabase default is 1 week with auto-refresh; configure 30 days in Supabase Dashboard if needed)
- Forms show translated validation errors
- Combined middleware handles both i18n and auth
- All pages use accessible design system (18px fonts, 48px buttons)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-04-SUMMARY.md` following the summary template.
</output>
